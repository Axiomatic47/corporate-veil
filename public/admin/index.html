<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      .preview-pane {
        padding: 20px;
      }
      .section-nav {
        margin-bottom: 20px;
        padding: 10px;
        background: #f3f4f6;
        border-radius: 4px;
      }
      .nav-button {
        margin-right: 8px;
        padding: 6px 12px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        cursor: pointer;
      }
      .nav-button.active {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }
      .new-section {
        margin-top: 16px;
        padding: 8px 16px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .new-section:disabled {
        background: #93c5fd;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      const PreviewComponent = createClass({
        render: function() {
          const entry = this.props.entry;
          const collection = this.props.collection;

          if (!entry || !collection) {
            return null;
          }

          const data = entry.get('data');
          return h('div', { className: 'preview-pane' },
            h('h1', {}, data.get('title')),
            h('div', {}, this.props.widgetFor('body'))
          );
        }
      });

      const withSections = createClass({
        getInitialState() {
          return { sections: [], isCreating: false };
        },

        componentDidMount() {
          this.mounted = true;
          this.loadSections();
        },

        componentWillUnmount() {
          this.mounted = false;
        },

        loadSections() {
          if (!this.props.entry) return;

          const collectionType = this.props.entry.get('data').get('collection_type');
          this.props.query('collections.compositions.entries')
            .then(entries => {
              if (!this.mounted) return;
              const sections = entries
                .filter(entry => entry.data.collection_type === collectionType)
                .map(entry => ({
                  section: entry.data.section,
                  slug: entry.slug
                }))
                .sort((a, b) => a.section - b.section);
              this.setState({ sections });
            })
            .catch(error => console.error('Error loading sections:', error));
        },

        handleNewSection() {
          if (this.state.isCreating) return;

          this.setState({ isCreating: true });
          const entry = this.props.entry;
          const data = entry.get('data');

          const title = data.get('title');
          const description = data.get('description');
          const collectionType = data.get('collection_type');
          const currentSection = parseInt(data.get('section'), 10);
          const newSection = currentSection + 1;

          const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const slug = date + '-' + title.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '-section-' + newSection;

          CMS.getBackend().createEntry('compositions', {
            slug,
            path: 'content/compositions/' + slug + '.md',
            raw: [
              '---',
              'title: ' + title + ' - Section ' + newSection,
              'description: ' + description,
              'collection_type: ' + collectionType,
              'section: ' + newSection,
              '---'
            ].join('\n')
          })
          .then(() => {
            window.location.href = '/admin/#/collections/compositions/entries/' + slug;
          })
          .catch(error => {
            console.error('Failed to create section:', error);
            alert('Failed to create new section');
            if (this.mounted) {
              this.setState({ isCreating: false });
            }
          });
        },

        render() {
          const currentSection = this.props.entry.get('data').get('section');

          return h('div', {},
            h('div', { className: 'section-nav' },
              this.state.sections.map(section =>
                h('button', {
                  key: section.section,
                  onClick: () => {
                    window.location.href = '/admin/#/collections/compositions/entries/' + section.slug;
                  },
                  className: 'nav-button' + (currentSection === section.section ? ' active' : '')
                }, 'Section ' + section.section)
              )
            ),
            h(PreviewComponent, this.props),
            h('button', {
              className: 'new-section',
              onClick: this.handleNewSection,
              disabled: this.state.isCreating
            }, this.state.isCreating ? 'Creating...' : 'New Section')
          );
        }
      });

      CMS.registerPreviewTemplate('compositions', withSections);
      CMS.init();
    </script>
  </body>
</html>