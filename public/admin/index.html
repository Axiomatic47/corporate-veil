<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      .new-section-button {
        display: inline-block;
        background-color: #2563eb;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        margin-top: 16px;
        font-size: 14px;
        transition: background-color 0.2s;
      }
      .new-section-button:hover:not(:disabled) {
        background-color: #1d4ed8;
      }
      .new-section-button:disabled {
        background-color: #93c5fd;
        cursor: not-allowed;
      }
      .preview-content {
        margin: 20px;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      // Wait for CMS initialization
      const waitForCMS = () => new Promise((resolve) => {
        const checkCMS = () => {
          if (CMS.getBackend()) {
            resolve();
          } else {
            setTimeout(checkCMS, 100);
          }
        };
        checkCMS();
      });

      const PreviewComponent = createClass({
        getInitialState() {
          return {
            isCreating: false,
            cmsReady: false
          };
        },

        async componentDidMount() {
          try {
            await waitForCMS();
            this.setState({ cmsReady: true });
            // Force re-render after CMS is ready
            this.forceUpdate();
          } catch (error) {
            console.error('Error in componentDidMount:', error);
          }
        },

        async createNewSection(entry) {
          if (!entry) throw new Error('No entry data');

          const data = entry.get('data');
          if (!data) throw new Error('No entry data');

          const title = data.get('title');
          const description = data.get('description');
          const collectionType = data.get('collection_type');
          const currentSection = parseInt(data.get('section') || '0', 10);

          const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const safeTitle = title.toLowerCase().replace(/[^a-z0-9]+/g, '-');
          const newSection = currentSection + 1;
          const newSlug = `${timestamp}-${safeTitle}-section-${newSection}`;

          const backend = CMS.getBackend();
          await backend.createEntry('compositions', {
            slug: newSlug,
            path: `content/compositions/${newSlug}.md`,
            raw: `---
title: ${title} - Section ${newSection}
description: ${description}
collection_type: ${collectionType}
section: ${newSection}
---
`
          });

          return newSlug;
        },

        handleNewSection: async function(e) {
          e.preventDefault();
          if (this.state.isCreating || !this.state.cmsReady) return;

          this.setState({ isCreating: true });
          try {
            const newSlug = await this.createNewSection(this.props.entry);
            window.location.href = `/admin/#/collections/compositions/entries/${newSlug}`;
          } catch (error) {
            console.error('Error creating new section:', error);
            alert('Failed to create new section. Please try again.');
            this.setState({ isCreating: false });
          }
        },

        render() {
          if (!this.state.cmsReady || !this.props.entry) return null;

          const entry = this.props.entry;
          const data = entry.get('data');

          if (!data) return null;

          return h('div', { className: 'preview-content' },
            h('h1', {}, data.get('title')),
            h('div', { className: 'content' }, this.props.widgetFor('body')),
            h('button', {
              className: 'new-section-button',
              onClick: this.handleNewSection,
              disabled: this.state.isCreating
            }, this.state.isCreating ? 'Creating...' : 'New Section')
          );
        }
      });

      // Initialize CMS with complete config
      window.addEventListener('load', () => {
        // Register preview template first
        CMS.registerPreviewTemplate('compositions', PreviewComponent);

        // Initialize CMS with full config
        CMS.init({
          config: {
            backend: {
              name: 'github',
              repo: 'Axiomatic47/corporate-veil',
              branch: 'main',
              base_url: 'https://api.netlify.com',
              auth_endpoint: 'auth'
            },
            media_folder: 'public/uploads',
            public_folder: '/uploads',
            collections: [{
              name: 'compositions',
              label: 'Compositions',
              folder: 'content/compositions',
              create: true,
              fields: [
                { label: 'Title', name: 'title', widget: 'string' },
                { label: 'Description', name: 'description', widget: 'text' },
                {
                  label: 'Collection Type',
                  name: 'collection_type',
                  widget: 'select',
                  options: ['memorandum', 'corrective']
                },
                { label: 'Section', name: 'section', widget: 'hidden', default: 1 },
                { label: 'Content', name: 'body', widget: 'markdown' }
              ]
            }],
            local_backend: true
          }
        });
      });
    </script>
  </body>
</html>