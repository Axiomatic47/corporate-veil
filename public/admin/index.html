<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      .preview-container {
        display: flex;
        min-height: calc(100vh - 56px);
      }
      .sidebar {
        width: 256px;
        background-color: #1A1F2C;
        color: white;
        padding: 1.5rem;
      }
      .preview-content {
        flex: 1;
        padding: 2rem;
      }
      .section-nav {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .section-button {
        padding: 0.5rem 1rem;
        background: transparent;
        color: #94a3b8;
        border: none;
        border-radius: 0.25rem;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s;
      }
      .section-button:hover {
        background: #2A2F3C;
        color: white;
      }
      .section-button.active {
        background: white;
        color: #1A1F2C;
      }
      .new-section-button {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background 0.2s;
      }
      .new-section-button:hover:not(:disabled) {
        background: #1d4ed8;
      }
      .new-section-button:disabled {
        background: #93c5fd;
        cursor: not-allowed;
      }
      .collection-title {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
      }
      .composition-title {
        color: #94a3b8;
        font-size: 1.125rem;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      const PreviewComponent = createClass({
        getInitialState() {
          return {
            sections: [],
            isCreating: false
          };
        },

        componentDidMount() {
          this.mounted = true;
          this.loadSections();
        },

        componentWillUnmount() {
          this.mounted = false;
        },

        async loadSections() {
          if (!this.props.entry) return;

          try {
            const currentEntry = this.props.entry;
            const collectionType = currentEntry.get('data').get('collection_type');

            // Get all entries from the collection
            const allEntries = await this.props.collection.entriesLoaded;
            if (!this.mounted) return;

            // Filter and sort entries
            const sections = allEntries
              .filter(entry => entry.data && entry.data.collection_type === collectionType)
              .map(entry => ({
                section: entry.data.section,
                slug: entry.slug
              }))
              .sort((a, b) => a.section - b.section);

            this.setState({ sections });
          } catch (error) {
            console.error('Error loading sections:', error);
          }
        },

        async handleNewSection() {
          if (this.state.isCreating) return;
          this.setState({ isCreating: true });

          try {
            const entry = this.props.entry;
            const data = entry.get('data');

            const title = data.get('title');
            const description = data.get('description');
            const collectionType = data.get('collection_type');
            const currentSection = parseInt(data.get('section'), 10);
            const newSection = currentSection + 1;

            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const safeTitle = title.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            const newSlug = `${timestamp}-${safeTitle}-section-${newSection}`;

            // Create new entry content
            const newContent = [
              '---',
              `title: ${title} - Section ${newSection}`,
              `description: ${description}`,
              `collection_type: ${collectionType}`,
              `section: ${newSection}`,
              '---'
            ].join('\n');

            // Save the new entry
            await this.props.collection.createEntry(
              'compositions',
              {
                path: `content/compositions/${newSlug}.md`,
                slug: newSlug,
                raw: newContent
              }
            );

            // Navigate to the new entry
            window.location.href = `/admin/#/collections/compositions/entries/${newSlug}`;
          } catch (error) {
            console.error('Error creating section:', error);
            alert('Failed to create new section. Please try again.');
            if (this.mounted) {
              this.setState({ isCreating: false });
            }
          }
        },

        render() {
          const entry = this.props.entry;
          if (!entry) return null;

          const data = entry.get('data');
          if (!data) return null;

          const currentSection = data.get('section');
          const collectionType = data.get('collection_type');
          const collectionTitle = collectionType === 'memorandum' ? 'Memorandum and Manifestation' : 'Corrective Measures';

          return h('div', { className: 'preview-container' },
            h('div', { className: 'sidebar' },
              h('div', { className: 'collection-title' }, collectionTitle),
              h('div', { className: 'composition-title' }, data.get('title')),
              h('div', { className: 'section-nav' },
                this.state.sections.map(section =>
                  h('button', {
                    key: section.section,
                    onClick: () => {
                      window.location.href = `/admin/#/collections/compositions/entries/${section.slug}`;
                    },
                    className: `section-button${currentSection === section.section ? ' active' : ''}`
                  }, `Section ${section.section}`)
                )
              ),
              h('button', {
                className: 'new-section-button',
                onClick: this.handleNewSection,
                disabled: this.state.isCreating
              }, this.state.isCreating ? 'Creating...' : 'New Section')
            ),
            h('div', { className: 'preview-content' },
              h('h1', {}, data.get('title')),
              h('div', {}, this.props.widgetFor('body'))
            )
          );
        }
      });

      // Initialize CMS
      CMS.init();

      // Register preview template
      CMS.registerPreviewTemplate('compositions', PreviewComponent);
    </script>
  </body>
</html>