<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      .preview-content {
        padding: 2rem;
        max-width: 800px;
        margin: 0 auto;
      }
      .content-preview {
        margin: 2rem 0;
      }
      .new-section-button {
        display: inline-block;
        background-color: #2563eb;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        margin-top: 16px;
        font-size: 14px;
      }
      .new-section-button:hover {
        background-color: #1d4ed8;
      }
      .new-section-button:disabled {
        background-color: #93c5fd;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      const createNewSection = async (entry) => {
        const data = entry.get('data').toJS();
        const collectionType = data.collection_type;
        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        const baseTitle = data.title.toLowerCase().replace(/\s+/g, '-');
        const newSlug = `${timestamp}-${baseTitle}-section-${data.section + 1}`;

        const entryData = {
          slug: newSlug,
          path: `content/compositions/${newSlug}.md`,
          data: {
            title: `${data.title} - Section ${data.section + 1}`,
            description: data.description,
            collection_type: collectionType,
            section: data.section + 1,
            body: ''
          }
        };

        const backend = await CMS.getBackend();
        await backend.implementation.persistEntry(entryData, { collection: 'compositions' });
        return newSlug;
      };

      const PreviewComponent = createClass({
        getInitialState() {
          return {
            isCreatingSection: false,
            error: null
          };
        },

        componentWillUnmount() {
          // Cleanup any pending state updates
          this.setState = () => {};
        },

        handleNewSection: async function(e) {
          e.preventDefault();
          if (this.state.isCreatingSection) return;

          this.setState({ isCreatingSection: true, error: null });

          try {
            const newSlug = await createNewSection(this.props.entry);
            // Use window.location.replace to prevent history stack issues
            window.location.replace(`/admin/#/collections/compositions/entries/${newSlug}`);
          } catch (error) {
            console.error('Error creating section:', error);
            this.setState({
              error: 'Failed to create new section. Please try again.',
              isCreatingSection: false
            });
          }
        },

        render: function() {
          const { entry, widgetFor } = this.props;
          const { isCreatingSection, error } = this.state;

          return h('div', { className: 'preview-content' },
            h('h1', {}, entry.getIn(['data', 'title'])),
            h('div', { className: 'content-preview' }, widgetFor('body')),
            error && h('div', { style: { color: 'red', marginTop: '1rem' } }, error),
            h('button', {
              className: 'new-section-button',
              onClick: this.handleNewSection,
              disabled: isCreatingSection
            }, isCreatingSection ? 'Creating...' : 'New Section')
          );
        }
      });

      // Initialize CMS
      if (window.CMS) {
        window.CMS.registerPreviewTemplate('compositions', PreviewComponent);
      }

      window.addEventListener('load', function() {
        CMS.init();
      });
    </script>
  </body>
</html>