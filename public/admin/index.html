<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      .new-section-button {
        display: inline-block;
        background-color: #2563eb;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        margin-top: 16px;
        font-size: 14px;
      }
      .new-section-button:hover {
        background-color: #1d4ed8;
      }
      .new-section-button:disabled {
        background-color: #93c5fd;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      // Create preview component before initialization
      const PreviewComponent = createClass({
        getInitialState() {
          return { isCreatingSection: false };
        },

        handleNewSection: async function(e) {
          e.preventDefault();
          if (this.state.isCreatingSection) return;

          const {entry} = this.props;
          const data = entry.get('data').toJS();
          const collectionName = entry.get('collection');

          this.setState({ isCreatingSection: true });

          try {
            // Get backend instance
            const backend = await CMS.getBackend();
            if (!backend) {
              throw new Error('CMS backend not available');
            }

            // Generate unique slug
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const baseTitle = data.title.toLowerCase().replace(/\s+/g, '-');
            const newSlug = `${timestamp}-${baseTitle}-new-section`;

            // Get existing entries to determine section number
            const entries = await backend.entries({ collection: collectionName });
            const existingSections = entries.filter(entry => 
              entry.slug.includes(baseTitle)
            ).length;

            const newSection = existingSections + 1;

            // Create new entry
            await backend.createEntry(collectionName, {
              slug: newSlug,
              path: `content/${collectionName}/${newSlug}.md`,
              data: {
                title: `${data.title} - Section ${newSection}`,
                description: data.description,
                section: newSection,
                body: ''
              }
            });

            // Navigate to the new entry
            window.location.href = `/admin/#/collections/${collectionName}/entries/${newSlug}`;
          } catch (error) {
            console.error('Error creating new section:', error);
            alert('Failed to create new section. Please try again.');
            this.setState({ isCreatingSection: false });
          }
        },

        render: function() {
          const {entry, widgetFor} = this.props;
          const data = entry.get('data').toJS();

          return h('div', { className: 'preview-content' },
            h('h1', {}, data.title),
            h('div', { className: 'content-preview' }, widgetFor('body')),
            h('button', {
              className: 'new-section-button',
              onClick: this.handleNewSection,
              disabled: this.state.isCreatingSection
            }, this.state.isCreatingSection ? 'Creating...' : 'New Section')
          );
        }
      });

      // Initialize CMS after component definition
      window.addEventListener('load', async function() {
        try {
          // Register preview templates first
          CMS.registerPreviewTemplate('memorandum', PreviewComponent);
          CMS.registerPreviewTemplate('corrective', PreviewComponent);
          
          // Initialize CMS with proper configuration
          await CMS.init({
            config: {
              load_config_file: true,
              local_backend: true,
              backend: {
                name: 'git-gateway',
                branch: 'main',
              }
            }
          });
        } catch (error) {
          console.error('Failed to initialize CMS:', error);
        }
      });
    </script>
  </body>
</html>