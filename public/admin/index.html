<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link href="/admin/styles/preview.css" rel="stylesheet" />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    CMS.registerPreviewStyle('/admin/styles/preview.css');
    
    const PreviewTemplate = createClass({
      render: function() {
        const entry = this.props.entry;
        const data = entry && entry.toJS ? entry.toJS().data : (entry?.data || {});
        
        const title = data.title || '';
        const description = data.description || '';
        const collectionType = data.collection_type || '';
        const section = data.section || 1;
        const body = this.props.widgetFor('body');

        const entries = this.props.entries;
        const allEntries = entries && entries.toJS ? entries.toJS().compositions : [];
        const relatedSections = Array.isArray(allEntries) 
          ? allEntries
              .filter(e => e.data.title === title)
              .map(e => e.data.section)
              .sort((a, b) => a - b)
          : [];

        return h('div', {className: 'preview-container'},
          h('div', {className: 'flex'},
            h('div', {className: 'w-64 bg-gray-800 p-4 min-h-screen'},
              h('h3', {className: 'text-white mb-4'}, 'Sections'),
              h('div', {className: 'space-y-2'},
                relatedSections.map(sectionNum =>
                  h('div', {
                    key: sectionNum,
                    className: `p-2 rounded ${section === sectionNum ? 'bg-white text-gray-800' : 'text-white'}`
                  }, `Section ${sectionNum}`)
                ),
                h('button', {
                  className: 'w-full mt-4 bg-blue-500 text-white p-2 rounded hover:bg-blue-600',
                  onClick: () => {
                    const newSection = Math.max(...relatedSections, 0) + 1;
                    const newData = entry && entry.get ? {...entry.get('data').toJS()} : {...data};
                    newData.section = newSection;
                    CMS.entry.set('data', newData);
                  }
                }, 'New Section')
              )
            ),
            h('div', {className: 'flex-1 p-8'},
              h('h1', {className: 'text-4xl font-bold mb-4'}, title),
              h('div', {className: 'meta-info mb-6'},
                h('p', {className: 'text-lg mb-2'}, description),
                h('div', {className: 'flex gap-4'},
                  h('span', {className: 'text-sm'}, `Collection: ${collectionType}`),
                  h('span', {className: 'text-sm'}, `Section: ${section}`)
                )
              ),
              h('div', {className: 'content mt-8'}, body)
            )
          )
        );
      }
    });

    CMS.registerPreviewTemplate('compositions', PreviewTemplate);

    CMS.registerEventListener({
      name: 'preSave',
      handler: async function(entry) {
        if (!entry) return entry;
        
        try {
          const data = entry.get ? entry.get('data') : entry.data;
          const title = data.get ? data.get('title') : data.title;
          
          if (!title) return entry;

          const entries = await CMS.getEntries({ collection_name: 'compositions' });
          const existingEntry = entries.find(e => {
            const entryData = e.get ? e.get('data') : e.data;
            const entryTitle = entryData.get ? entryData.get('title') : entryData.title;
            const entrySection = entryData.get ? entryData.get('section') : entryData.section;
            return entryTitle === title && entrySection === 1;
          });
          
          if (existingEntry) {
            const titleField = document.querySelector('[name="title"]');
            if (titleField) titleField.setAttribute('readonly', true);
          }
        } catch (error) {
          console.error('Error in preSave handler:', error);
        }
        
        return entry;
      }
    });
  </script>
</body>
</html>