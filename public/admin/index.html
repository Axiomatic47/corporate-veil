<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <link rel="stylesheet" href="styles/preview.css">
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      // Initialize CMS with custom config
      CMS.init({
        config: {
          load_config_file: false,
          backend: {
            name: 'github',
            repo: 'Axiomatic47/corporate-veil',
            branch: 'main',
            base_url: 'https://api.netlify.com',
            auth_endpoint: 'auth'
          },
          media_folder: 'public/uploads',
          public_folder: '/uploads',
          collections: [{
            name: 'compositions',
            label: 'Compositions',
            folder: 'content/compositions',
            create: true,
            format: 'frontmatter',
            extension: 'md',
            identifier_field: 'title',
            fields: [
              { label: 'Title', name: 'title', widget: 'string', required: true },
              { label: 'Description', name: 'description', widget: 'text', required: true },
              {
                label: 'Collection Type',
                name: 'collection_type',
                widget: 'select',
                options: ['memorandum', 'corrective'],
                required: true
              },
              { label: 'Section', name: 'section', widget: 'hidden', default: 1 },
              { label: 'Content', name: 'body', widget: 'markdown', required: true }
            ],
            sortable_fields: ['title', 'section'],
            view_filters: [
              { label: 'Memorandum', field: 'collection_type', pattern: 'memorandum' },
              { label: 'Corrective', field: 'collection_type', pattern: 'corrective' }
            ]
          }]
        }
      });

      // Wait for CMS to be ready before registering preview
      CMS.registerEventListener({
        name: 'preSave',
        handler: async function(entry) {
          return entry;
        }
      });
    </script>
    <script src="components/PreviewComponent.js"></script>
  </body>
</html>